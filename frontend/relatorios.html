<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Relatórios do Sistema</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: #f8f9fa; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
        header, footer { background-color: #343a40; padding: 10px; text-align: center; color: #ffffff; font-size: 1.5rem; font-weight: 500; }
        footer { padding: 5px; font-size: 12px; }
        main { display: flex; flex: 1; justify-content: center; padding: 20px; }
        #relatorios-container { width: 100%; max-width: 1000px; }
        .section-title { font-size: 2rem; font-weight: 700; color: #343a40; margin-bottom: 20px; border-bottom: 3px solid #007bff; padding-bottom: 10px; }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .report-card { background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 20px; text-align: center; transition: transform 0.2s; cursor: pointer; }
        .report-card:hover { transform: translateY(-5px); }
        .report-card .material-icons { font-size: 48px; color: #007bff; margin-bottom: 15px; }
        .report-card h3 { margin: 0; font-size: 1.2rem; color: #495057; }
        #output-area { background-color: #ffffff; border-radius: 12px; padding: 25px; margin-top: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); min-height: 150px; display: none; }
        #output-area h3 { margin-top: 0; color: #007bff; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; }
        .relatorio-item { background-color: #f8f9fa; color: #495057; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.95rem; border-left: 5px solid #007bff; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .relatorio-item strong { color: #343a40; }
        #registrar-compra { background-color: #ffffff; padding: 25px; border-radius: 12px; margin-top: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        input, select, button { padding: 12px; margin: 8px 0; width: 100%; border: 1px solid #ced4da; border-radius: 8px; font-size: 1rem; font-family: 'Roboto', sans-serif; }
        button.action-button { background-color: #007bff; color: white; font-weight: 500; cursor: pointer; transition: background-color 0.2s; border: none; }
        button.action-button:hover { background-color: #0056b3; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-content h3 { margin-top: 0; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .cancel-button { background-color: #6c757d; }
    </style>
</head>
<body>
    <header>Sistema de Comandas - Relatórios</header>
    <main>
        <div id="relatorios-container">
            <h2 class="section-title">Painel de Relatórios</h2>
            <div class="report-grid">
                <div class="report-card" onclick="abrirModalFiltroVendas()">
                    <span class="material-icons">picture_as_pdf</span>
                    <h3>Baixar Relatório de Vendas (PDF)</h3>
                </div>
                <div class="report-card" onclick="mostrarRelatorioEstoque()">
                    <span class="material-icons">inventory_2</span>
                    <h3>Visualizar Estoque</h3>
                </div>
                 <div class="report-card" onclick="mostrarRelatorioCompras()">
                    <span class="material-icons">shopping_cart</span>
                    <h3>Visualizar Compras</h3>
                </div>
            </div>
            <div id="output-area"></div>
            <div id="registrar-compra">
                <h2 class="section-title">Registrar Nova Compra de Insumos</h2>
                <input type="date" id="dataCompra" />
                <select id="metodoPagamentoCompra">
                    <option value="">Selecione o Método de Pagamento</option>
                    <option value="Dinheiro">Dinheiro</option><option value="PIX">PIX</option>
                    <option value="Débito">Débito</option><option value="Crédito">Crédito</option>
                </select>
                <input id="produtoCompra" placeholder="Nome do Produto/Insumo Comprado" />
                <input type="number" id="valorCompra" placeholder="Valor da Compra (R$)" />
                <button class="action-button" onclick="adicionarCompra()">Registrar Compra</button>
            </div>
        </div>
    </main>
    
    <div id="modalFiltroVendas" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Gerar Relatório de Vendas</h3>
            <p>Selecione o mês e o ano para gerar o PDF.</p>
            <select id="filtroMes">
                <option value="1">Janeiro</option><option value="2">Fevereiro</option>
                <option value="3">Março</option><option value="4">Abril</option>
                <option value="5">Maio</option><option value="6">Junho</option>
                <option value="7">Julho</option><option value="8">Agosto</option>
                <option value="9">Setembro</option><option value="10">Outubro</option>
                <option value="11">Novembro</option><option value="12">Dezembro</option>
            </select>
            <input type="number" id="filtroAno" placeholder="Digite o ano (ex: 2025)">
            <div class="modal-actions">
                <button class="action-button" onclick="gerarPdfVendas()">Gerar PDF</button>
                <button class="cancel-button" onclick="fecharModal('modalFiltroVendas')">Cancelar</button>
            </div>
        </div>
    </div>

    <footer>FKSoft &copy; 2025</footer>
    <script>
        const token = localStorage.getItem('authToken');
        if (!token) {
            window.location.href = '/login.html';
        }
        const outputArea = document.getElementById('output-area');

        function solicitarSenha() {
            const senha = prompt("Para realizar esta ação, por favor, digite a senha de administrador:");
            return senha === "123";
        }

        async function fetchComAuth(url) {
            return fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
        }

        function abrirModalFiltroVendas() {
            if (!solicitarSenha()) return alert("Senha incorreta.");
            const hoje = new Date();
            document.getElementById('filtroMes').value = hoje.getMonth() + 1;
            document.getElementById('filtroAno').value = hoje.getFullYear();
            document.getElementById('modalFiltroVendas').style.display = 'flex';
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        async function gerarPdfVendas() {
            const mes = document.getElementById('filtroMes').value;
            const ano = document.getElementById('filtroAno').value;
            if (!ano) return alert('Por favor, digite o ano.');

            try {
                const response = await fetch(`/api/relatorios/vendas/filtrado?ano=${ano}&mes=${mes}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Não foi possível buscar os dados do relatório.');
                
                const vendas = await response.json();
                if (vendas.length === 0) {
                    alert(`Nenhuma venda encontrada para ${mes}/${ano}.`);
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.text(`Relatório de Vendas - ${mes}/${ano}`, 14, 16);
                
                const tableColumn = ["Data", "Cliente", "Produto", "Pagamento", "Valor", "Desconto"];
                const tableRows = [];
                let totalVendas = 0, totalDescontos = 0;

                vendas.forEach(venda => {
                    const data = new Date(venda.data_venda).toLocaleString('pt-BR');
                    const valor = parseFloat(venda.produto_preco);
                    const desconto = parseFloat(venda.desconto);
                    const vendaData = [ data, venda.cliente_nome || 'N/A', venda.produto_nome, venda.metodo_pagamento, `R$ ${valor.toFixed(2)}`, `R$ ${desconto.toFixed(2)}` ];
                    tableRows.push(vendaData);
                    totalVendas += valor;
                    totalDescontos += desconto;
                });

                doc.autoTable({ head: [tableColumn], body: tableRows, startY: 20 });
                
                const finalY = doc.lastAutoTable.finalY || 20;
                doc.text(`Total Bruto: R$ ${totalVendas.toFixed(2)}`, 14, finalY + 10);
                doc.text(`Total Descontos: R$ ${totalDescontos.toFixed(2)}`, 14, finalY + 15);
                doc.text(`Total Líquido: R$ ${(totalVendas - totalDescontos).toFixed(2)}`, 14, finalY + 20);

                doc.save(`relatorio_vendas_${mes}_${ano}.pdf`);
                fecharModal('modalFiltroVendas');

            } catch(error) {
                alert(error.message);
                console.error(error);
            }
        }

        async function mostrarRelatorioEstoque() {
            if (!solicitarSenha()) return alert("Senha incorreta.");
            // ... (código existente)
        }

        async function mostrarRelatorioCompras() {
            if (!solicitarSenha()) return alert("Senha incorreta.");
            // ... (código existente)
        }
        
        async function adicionarCompra() {
            // ... (código existente)
        }
    </script>
</body>
</html>