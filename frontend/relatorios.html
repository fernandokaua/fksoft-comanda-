<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Relatórios do Sistema</title><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" /><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"><style>*{box-sizing:border-box}body{margin:0;font-family:'Roboto',sans-serif;background-color:#f8f9fa;color:#333;display:flex;flex-direction:column;min-height:100vh}header,footer{background-color:#343a40;padding:10px;text-align:center;color:#fff;font-size:1.5rem;font-weight:500}footer{padding:5px;font-size:12px}main{display:flex;flex:1;justify-content:center;padding:20px}#relatorios-container{width:100%;max-width:1000px}.section-title{font-size:2rem;font-weight:700;color:#343a40;margin-bottom:20px;border-bottom:3px solid #007bff;padding-bottom:10px}.report-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:30px}.report-card{background-color:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);padding:20px;text-align:center;transition:transform .2s;cursor:pointer}.report-card:hover{transform:translateY(-5px)}.report-card .material-icons{font-size:48px;color:#007bff;margin-bottom:15px}.report-card h3{margin:0;font-size:1.2rem;color:#495057}#output-area{background-color:#fff;border-radius:12px;padding:25px;margin-top:20px;box-shadow:0 4px 12px rgba(0,0,0,.08);min-height:150px}#output-area h3{margin-top:0;color:#007bff;border-bottom:2px solid #e9ecef;padding-bottom:10px}.relatorio-item{background-color:#f8f9fa;color:#495057;padding:12px;border-radius:8px;margin-bottom:10px;font-size:.95rem;border-left:5px solid #007bff;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}.relatorio-item strong{color:#343a40}#registrar-compra{background-color:#fff;padding:25px;border-radius:12px;margin-top:30px;box-shadow:0 4px 12px rgba(0,0,0,.08)}input,select,button{padding:12px;margin:8px 0;width:100%;border:1px solid #ced4da;border-radius:8px;font-size:1rem;font-family:'Roboto',sans-serif}button.action-button{background-color:#007bff;color:#fff;font-weight:500;cursor:pointer;transition:background-color .2s;border:none}button.action-button:hover{background-color:#0056b3}</style>
</head>
<body>
    <header>Sistema de Comandas - Relatórios</header>
    <main>
        <div id="relatorios-container">
            <h2 class="section-title">Painel de Relatórios</h2>
            <div class="report-grid">
                <div class="report-card" onclick="mostrarRelatorioVendas()">
                    <span class="material-icons">point_of_sale</span>
                    <h3>Relatório de Vendas</h3>
                </div>
                <div class="report-card" onclick="mostrarRelatorioEstoque()">
                    <span class="material-icons">inventory_2</span>
                    <h3>Relatório de Estoque</h3>
                </div>
                 <div class="report-card" onclick="mostrarRelatorioCompras()">
                    <span class="material-icons">shopping_cart</span>
                    <h3>Relatório de Compras</h3>
                </div>
            </div>
            <div id="output-area" style="display: none;"></div>
            <div id="registrar-compra">
                <h2 class="section-title">Registrar Nova Compra de Insumos</h2>
                <input type="date" id="dataCompra" /><select id="metodoPagamentoCompra"><option value="">Selecione o Método de Pagamento</option><option value="Dinheiro">Dinheiro</option><option value="PIX">PIX</option><option value="Débito">Débito</option><option value="Crédito">Crédito</option></select>
                <input id="produtoCompra" placeholder="Nome do Produto/Insumo Comprado" /><input type="number" id="valorCompra" placeholder="Valor da Compra (R$)" /><button class="action-button" onclick="adicionarCompra()">Registrar Compra</button>
            </div>
        </div>
    </main>
    <footer>FKSoft &copy; 2025</footer>
    <script>
        const token = localStorage.getItem('authToken');
        if (!token) {
            window.location.href = '/login.html';
        }
        const outputArea = document.getElementById('output-area');

        function solicitarSenha() {
            const senha = prompt("Para realizar esta ação, por favor, digite a senha de administrador:");
            return senha === "123";
        }

        async function fetchComAuth(url) {
            return fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
        }

        async function mostrarRelatorioVendas() {
            if (!solicitarSenha()) return alert("Senha incorreta.");
            try {
                const response = await fetchComAuth('/api/relatorios/vendas');
                if(!response.ok) throw new Error("Falha ao buscar relatório.");
                const vendas = await response.json();
                outputArea.style.display = 'block';
                let content = '<h3>Relatório de Vendas</h3>';
                if(vendas.length === 0) content += '<p>Nenhuma venda registrada.</p>';
                else {
                    vendas.forEach(v => {
                        const data = new Date(v.data_venda).toLocaleString('pt-BR');
                        content += `<div class="relatorio-item"><span>${data} - <strong>Produto:</strong> ${v.produto_nome}</span><span><strong>Valor:</strong> R$ ${parseFloat(v.produto_preco).toFixed(2)} - <strong>Pgto:</strong> ${v.metodo_pagamento}</span></div>`;
                    });
                }
                outputArea.innerHTML = content;
            } catch (error) { alert(error.message); }
        }
        
        async function mostrarRelatorioEstoque() {
            if (!solicitarSenha()) return alert("Senha incorreta.");
            try {
                const response = await fetchComAuth('/api/estoque');
                if(!response.ok) throw new Error("Falha ao buscar relatório.");
                const estoque = await response.json();
                outputArea.style.display = 'block';
                let content = '<h3>Relatório de Estoque</h3>';
                if(estoque.length === 0) content += '<p>Estoque vazio.</p>';
                else {
                    estoque.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(p => {
                         content += `<div class="relatorio-item"><span><strong>Produto:</strong> ${p.nome} (Cód: ${p.codigo})</span><span><strong>Preço:</strong> R$ ${p.preco.toFixed(2)} - <strong>Qtd:</strong> ${p.quantidade}</span></div>`;
                    });
                }
                outputArea.innerHTML = content;
            } catch (error) { alert(error.message); }
        }

        async function mostrarRelatorioCompras() {
            if (!solicitarSenha()) return alert("Senha incorreta.");
            try {
                const response = await fetchComAuth('/api/relatorios/compras');
                if(!response.ok) throw new Error("Falha ao buscar relatório.");
                const compras = await response.json();
                outputArea.style.display = 'block';
                let content = '<h3>Relatório de Compras</h3>';
                if (compras.length === 0) content += '<p>Nenhuma compra registrada.</p>';
                else {
                    compras.forEach(c => {
                        const data = new Date(c.data_compra).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                        content += `<div class="relatorio-item"><span>${data} - <strong>Produto:</strong> ${c.produto}</span><span><strong>Valor:</strong> R$ ${parseFloat(c.valor).toFixed(2)} - <strong>Pgto:</strong> ${c.metodo_pagamento}</span></div>`;
                    });
                }
                outputArea.innerHTML = content;
            } catch (error) { alert(error.message); }
        }
        
        async function adicionarCompra() {
            const compra = {
                dataCompra: document.getElementById('dataCompra').value,
                metodoPagamento: document.getElementById('metodoPagamentoCompra').value,
                produto: document.getElementById('produtoCompra').value,
                valor: parseFloat(document.getElementById('valorCompra').value)
            };
            if(!compra.dataCompra || !compra.metodoPagamento || !compra.produto || isNaN(compra.valor)) {
                return alert('Preencha todos os campos da compra.');
            }
            try {
                const response = await fetch('/api/relatorios/compras', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(compra)
                });
                if (!response.ok) throw new Error('Falha ao registrar compra.');
                alert('Compra registrada com sucesso!');
                document.getElementById('dataCompra').value = '';
                document.getElementById('metodoPagamentoCompra').value = '';
                document.getElementById('produtoCompra').value = '';
                document.getElementById('valorCompra').value = '';
            } catch(error) { alert(error.message); }
        }
    </script>
</body>
</html>